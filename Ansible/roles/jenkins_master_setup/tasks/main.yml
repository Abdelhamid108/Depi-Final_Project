---
# -----------------------------------------------------------------------------
# Role: Jenkins Master Setup
# -----------------------------------------------------------------------------
# Deploys and configures the Jenkins Master server.
# - Installs Jenkins (apt/yum)
# - Configures 'jenkins' user and Docker access
# - Unlocks Jenkins using Groovy scripts (bypassing setup wizard)
# - Creates Admin user and installs plugins
# - Configures Credentials (AWS, SSH, Database)
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Installation
# -----------------------------------------------------------------------------

# Add Jenkins GPG key (Debian/Ubuntu)
- name: add GPG key for jenkins
  ansible.builtin.get_url:
    url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
    dest: /etc/apt/keyrings/jenkins-keyring.asc
    mode: 'a+r'
  when: ansible_distribution in ["Debian", "Ubuntu"]

# Add Jenkins Repository (Debian/Ubuntu)
- name: add jenkins repo
  apt_repository:
    repo: 'deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/'
    state: present
    filename: jenkins
    update_cache: yes
  when: ansible_distribution in ["Debian", "Ubuntu"]

# Add Jenkins Repository (RedHat)
- name: Add multiple repositories into the same file 
  ansible.builtin.yum_repository:
    name: Jenkins
    description: Jenkins YUM repo
    baseurl: "https://pkg.jenkins.io/redhat-stable/"
    gpgcheck: yes
    enabled: yes
    gpgkey: "https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key"
  when: ansible_os_family == "RedHat"

# Refresh Cache (RedHat)
- name: Clean and rebuild DNF/YUM metadata cache
  ansible.builtin.dnf:
    name: '*' 
    state: latest 
    update_cache: yes
  when: ansible_os_family == "RedHat"
  become: yes

# Install Jenkins Package
- name: install jenkins engine
  package:
    name:
      - jenkins
    state: present
    update_cache: yes
  notify: start_enable_jenkins

# Add 'jenkins' user to 'docker' group to allow building images
- name: add jenkins user to docker group
  user:
    name: jenkins
    groups: docker
    state: present 
    append: yes

# Force Jenkins start immediately to proceed with configuration
- name: Run jenkins handler now so jenkins intialization setup can proceed
  ansible.builtin.meta: flush_handlers

# -----------------------------------------------------------------------------
# Configuration & Unlocking
# -----------------------------------------------------------------------------

# Read the initial auto-generated admin password
- name: read admin pwd
  shell: cat /var/lib/jenkins/secrets/initialAdminPassword
  register: secretpwd

# Unlock Jenkins and create the first Admin user via Groovy script
- name: unlock and add admin user
  jenkins_script:
    script: |
          import jenkins.model.*
          import hudson.security.*
          def instance = Jenkins.getInstance()
          def hudsonRealm = new HudsonPrivateSecurityRealm(false)
          hudsonRealm.createAccount('Jenkins', '${user_pwd}')
          instance.setSecurityRealm(hudsonRealm)
          def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
          strategy.setAllowAnonymousRead(false)
          instance.setAuthorizationStrategy(strategy)
          instance.save()
    args:
      user_pwd: admin # Note: Ideally use Ansible Vault for this password
    user: admin
    password: "{{ secretpwd.stdout }}"

# Mark the setup wizard as complete
- name: complete setup wizard
  jenkins_script:
    script: |
          import static jenkins.model.Jenkins.instance as jenkins
          import jenkins.install.InstallState
          if (!jenkins.installState.isSetupComplete()) {
            InstallState.INITIAL_SETUP_COMPLETED.initializeState()
          }
    user: admin
    password: "{{ secretpwd.stdout }}"


# Check Jenkins instaleed plugins marker file exist
- name: Check plugins marker file 
  stat:
    path: /tmp/installed_plugins
  register: plugins_installed_marker

# Install required plugins defined in 'jenkins_plugins' variable
- name: install plugin
  jenkins_plugin:
    name: "{{ item }}"
    state: present
    url_username: admin
    url_password: "{{ secretpwd.stdout }}"
  with_items: "{{ jenkins_plugins }}"
  when: not plugins_installed_marker.stat.exists  
  notify: restart_jenkins

#create a marker file for plugins installation process if its already done 
- name:
  file:
    path: /tmp/installed_plugins
    state: touch
    owner: jenkins
    group: jenkins
  when: not plugins_installed_marker.stat.exists

# Restart Jenkins to load plugins
- name: Restart Jenkins to load new plugins
  ansible.builtin.meta: flush_handlers

# Install 'python-jenkins' library for Ansible modules
- name: Install python3-jenkins library (required for modules)
  pip:
    name: python-jenkins
    state: present
 
# -----------------------------------------------------------------------------
# Credential Management
# -----------------------------------------------------------------------------

# Generate an API Token for Ansible to use for subsequent API calls
- name: Generate Jenkins API Token
  community.general.jenkins_credential:
    name: "ansible-token"
    type: token
    jenkins_user: Jenkins
    jenkins_password: admin
    url: http://localhost:8080
  register: jenkins_token_result

# Prepare SSH Key for Agents (Copy from local to temp)
- name: Copy SSH Key to Temp File
  copy:
    content: "{{ lookup('file', '~/.ssh/jenkins_key') }}"
    dest: /tmp/jenkins_agent_key
    mode: '0600'    

# Create SSH Credential in Jenkins
- name: Create SSH Key Credential
  community.general.jenkins_credential:
    id: jenkins-ssh-key
    type: ssh_key
    username: jenkins
    private_key_path: "/tmp/jenkins_agent_key"
    state: present
    url: http://localhost:8080
    jenkins_user: Jenkins
    token: "{{ jenkins_token_result.token }}"

# Cleanup temp key file
- name: Remove Temp SSH Key File
  file:
    path: "/tmp/jenkins_agent_key"
    state: absent      

# Create AWS Access Key Credential
- name: Create Aws access Key Credential
  community.general.jenkins_credential:
    id: aws-access-key
    description: "credential for s3 bcuket access key"  
    type: text
    username: jenkins
    secret: "{{ aws_access_key_id }}"
    state: present
    url: http://localhost:8080
    jenkins_user: Jenkins
    token: "{{ jenkins_token_result.token }}"      
      
# Create AWS Secret Key Credential
- name: Create Aws secret access  Key Credential
  community.general.jenkins_credential:
    id: aws-secret-key
    description: "credential for s3 bcuket access key"
    type: text
    username: jenkins
    secret: "{{ aws_secret_access_key }}"
    state: present
    url: http://localhost:8080
    jenkins_user: Jenkins
    token: "{{ jenkins_token_result.token }}"

# Create Database Credentials
- name: Add DATABASE user_and_pass credential
  community.general.jenkins_credential:
    id: "mongo_db_creds"
    type: "user_and_pass"
    jenkins_user: Jenkins
    token: "{{ jenkins_token_result.token }}"
    description: "DB User and password credential"
    username: "{{ mongo_db_user }}"
    password: "{{mongo_db_pass }}"

# Create JWT Secret Credential
- name: Create AWS JWT secret  KeY Credential
  community.general.jenkins_credential:
    id: amazona-jwt-key
    description: "credential for JWT key"
    type: text
    username: jenkins
    secret: "{{ amazona_jwt_secret }}"
    state: present
    url: http://localhost:8080
    jenkins_user: Jenkins
    token: "{{ jenkins_token_result.token }}"



