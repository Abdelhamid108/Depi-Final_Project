- name: add GPG key for jenkins
  ansible.builtin.get_url:
    url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
    dest: /etc/apt/keyrings/jenkins-keyring.asc
    mode: 'a+r'
  when: ansible_distribution in ["Debian", "Ubuntu"]

- name: add jenkins repo
  apt_repository:
    repo: 'deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/'
    state: present
    filename: jenkins
    update_cache: yes
  when: ansible_distribution in ["Debian", "Ubuntu"]

- name: Add multiple repositories into the same file 
  ansible.builtin.yum_repository:
    name: Jenkins
    description: Jenkins YUM repo
    baseurl: "https://pkg.jenkins.io/redhat-stable/jenkins.repo"
    gpgcheck: yes
    enabled: yes
    gpgkey: "https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key"
  when: ansible_os_family == "RedHat"

- name: install jenkins engine
  package:
    name:
      - jenkins
    state: present
  notify: start_enable_jenkins

- name: Run jenkins handler now so jenkins intialization setup can proceed
  ansible.builtin.meta: flush_handlers

- name: unlock and add admin user
  jenkins_script:
    script: |
          import jenkins.model.*
          import hudson.security.*
          def instance = Jenkins.getInstance()
          def hudsonRealm = new HudsonPrivateSecurityRealm(false)
          hudsonRealm.createAccount('Jenkins', '${user_pwd}')
          instance.setSecurityRealm(hudsonRealm)
          def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
          strategy.setAllowAnonymousRead(false)
          instance.setAuthorizationStrategy(strategy)
          instance.save()
    args:
      user_pwd: admin
    user: admin
    password: "{{ secretpwd.stdout }}"

- name: complete setup wizard
  jenkins_script:
    script: |
          import static jenkins.model.Jenkins.instance as jenkins
          import jenkins.install.InstallState
          if (!jenkins.installState.isSetupComplete()) {
            InstallState.INITIAL_SETUP_COMPLETED.initializeState()
          }
    user: admin
    password: "{{ secretpwd.stdout }}"

- name: install plugin
  jenkins_plugin:
    name: "{{ item }}"
    state: latest
    url_username: admin
    url_password: "{{ secretpwd.stdout }}"
  with_items:
    - git
    - pipeline
    - github
    - docker-plugin
    - slack
    - ssh-agent
    - credentials-binding
    - docker-workflow
    - aws-credentials  # Additional AWS Credentials Plugin
    - multibranch-scan-webhook-trigger
    - multibranch-build-strategy-extension
  notify: restart_jenkins

    
