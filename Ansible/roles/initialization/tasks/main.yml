---
# -----------------------------------------------------------------------------
# Role: Initialization
# -----------------------------------------------------------------------------
# Performs basic server setup tasks required before other roles run.
# - Updates package cache (apt/yum)
# - Installs essential system tools (vim, git, curl, etc.)
# - Installs Python libraries for Ansible modules
# - Installs Helm for Kubernetes package management
# -----------------------------------------------------------------------------

# Update apt cache for Debian/Ubuntu systems to ensure we get the latest package versions
- name: update cache (necessary for debian and ubuntu based)
  apt:
    update_cache: yes
  when: ansible_os_family == "Debian"
  changed_when: false

# Install common utility packages needed for administration and deployment
- name: install important needed packages 
  package:
    name: 
      - vim            # Text editor
      - git            # Version control
      - acl            # Access Control Lists (often needed for Ansible become)
      - python3-pip    # Python package manager
    update_cache: yes
    state: present

# Install the 'kubernetes' Python library
# This is REQUIRED for Ansible's k8s modules to interact with the cluster later
- name: Install kubernetes python library (Critical for Ansible k8s modules)
  pip:
    name: kubernetes
    state: present
    executable: pip3

# Install Helm (Kubernetes Package Manager)
# Downloads the installation script and runs it
- name: helm install
  shell: "curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4 | bash"
  args:
    creates: "/tmp/install-helm.txt" # Prevents re-running if this file exists (though script creates binary)
  register: helm_installation
  changed_when: helm_installation.rc == 0

# Create a marker file to track that Helm installation attempted/completed
- name: Create marker file for installing helm
  file:
    path: "/tmp/helm_installation"
    state: touch
  when: helm_installation.changed

