---
# -----------------------------------------------------------------------------
# Role: Jenkins Agents Setup
# -----------------------------------------------------------------------------
# Configures nodes to act as Jenkins Agents (Workers).
# - Installs Java (JDK 21) required for Jenkins agent runtime
# - Installs SSH server for master-agent communication
# - Creates 'jenkins' user and configures SSH authorized keys
# -----------------------------------------------------------------------------

# Install basic dependencies
- name: Ensure the necessary packages are present
  ansible.builtin.package:
    name:
      - wget
      - gpg
      - openssh-server # Needed for Jenkins to SSH into the agent
      - fontconfig     # Dependency for Java
    update_cache: yes
    state: present
  notify: start_sshd

# -----------------------------------------------------------------------------
# Java Installation (JDK 21)
# -----------------------------------------------------------------------------

# Add Adoptium GPG Key (Debian/Ubuntu)
- name: Download the Eclipse Adoptium GPG key
  ansible.builtin.get_url:
    url: https://packages.adoptium.net/artifactory/api/gpg/key/public
    dest: /etc/apt/keyrings/adoptium.asc
    mode: 'a+r'
  when: ansible_distribution in ["Debian", "Ubuntu"]

# Add Adoptium Repository (Debian/Ubuntu)
- name: Add Adoptium repo
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/adoptium.asc] https://packages.adoptium.net/artifactory/deb  {{ ansible_distribution_release }} main"
    state: present
    filename: adoptium
    update_cache: yes
  when: ansible_distribution in ["Debian", "Ubuntu"]

# Add Adoptium Repository (RedHat)
- name: Add multiple repositories into the same file (
  ansible.builtin.yum_repository:
    name: Adoptium
    description: Adoptium YUM repo
    baseurl: "https://packages.adoptium.net/artifactory/rpm/rhel/9/$basearch"
    gpgcheck: yes
    enabled: yes
    gpgkey: "https://packages.adoptium.net/artifactory/api/gpg/key/public"
  when: ansible_os_family == "RedHat"

# Install JDK 21
- name: install java(jdk)
  ansible.builtin.package:
    name:
      - temurin-21-jdk # Installs JDK 21
    state: present
  notify: start_sshd

# -----------------------------------------------------------------------------
# User Configuration
# -----------------------------------------------------------------------------

# Create 'jenkins' user on worker nodes
- name: ensure user jenkins exist
  user:
    name: jenkins
    state: present
    shell: /bin/bash
    create_home: yes
    groups: docker # Adds user to 'docker' group to run docker commands
    append: yes
  when: inventory_hostname in groups['k8s_cluster'] # Only runs on workers

# Configure SSH Access
# Copies the public key from the Jenkins Master (files/depi_jenkins_rsa.pub)
# to the authorized_keys of the 'jenkins' user on this agent.
- name: Set authorized key taken from file
  ansible.posix.authorized_key:
    user: jenkins
    state: present
    key: "{{ lookup('file', '../files/depi_jenkins_rsa.pub') }}"
  when: inventory_hostname in groups['k8s_cluster'] # Only runs on workers

