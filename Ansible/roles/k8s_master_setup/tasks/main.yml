---
# -----------------------------------------------------------------------------
# Role: Kubernetes Master Setup
# -----------------------------------------------------------------------------
# Bootstraps the Kubernetes Control Plane.
# - Pulls Kubeadm images
# - Initializes the cluster (kubeadm init)
# - Configures kubectl for 'k8s_manager' and 'jenkins' users
# - Installs Calico CNI for pod networking
# - Generates and saves the Join Token for worker nodes
# -----------------------------------------------------------------------------

# Pre-pull images to speed up initialization and reduce timeout risks
- name: Pull required Kubernetes images in advance
  command: "kubeadm config images pull --cri-socket=unix:///var/run/cri-dockerd.sock"
  args:
    creates: "/tmp/kubeadm-images-pulled.txt"
  register: pull_images
  changed_when: pull_images.rc == 0

# Mark image pull as complete
- name: Create marker file for image pull 
  file:
    path: "/tmp/kubeadm-images-pulled.txt"
    state: touch
  when: pull_images.changed


# -----------------------------------------------------------------------------
# Cluster Initialization
# -----------------------------------------------------------------------------

# Initialize the Control Plane
# - Specifies the CRI socket (cri-dockerd)
# - Sets the Pod Network CIDR (required for Calico)
# - Advertises the API server on the default IPv4 address
- name: intiate the cluster
  command: |
      kubeadm init \
      --cri-socket=unix:///var/run/cri-dockerd.sock \
      --apiserver-advertise-address={{ ansible_default_ipv4.address }} \
      --apiserver-cert-extra-sans={{ ansible_default_ipv4.address }} \
      --pod-network-cidr={{ pod_network_cidr }} \
      --ignore-preflight-errors Swap
  args:
    creates: /etc/kubernetes/admin.conf # Idempotency check
  register: kubeadm_init
  changed_when: "'Your Kubernetes control-plane has initialized successfully' in kubeadm_init.stdout"

# -----------------------------------------------------------------------------
# User Configuration (k8s_manager)
# -----------------------------------------------------------------------------

# Configure a dedicated user for cluster management
- name: Configure kubeconfig for the dedicated 'k8s_manager' user
  block:
    - name: create a user for kubernetes
      user:
        name: "{{ k8s_user }}"
        shell: /bin/bash
        state: present

    - name: create kube config directory
      file:
        path: "/home/{{ k8s_user }}/.kube"
        state: directory
        owner: "{{ k8s_user }}"
        group: "{{ k8s_user }}"
        mode: '0755'
    
    # Copy admin.conf to user's config to grant admin access
    - name: copy conf files to cuurent use config directory
      copy:
        src: "/etc/kubernetes/admin.conf"
        dest: "/home/{{ k8s_user }}/.kube/config"
        remote_src: yes
        owner: "{{ k8s_user }}"
        group: "{{ k8s_user }}"
        mode: '0644'

# -----------------------------------------------------------------------------
# Network Plugin (Calico)
# -----------------------------------------------------------------------------

# Install Calico CNI for Pod Networking
- name: Install Calico cni
  command: "kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/calico.yaml"
  args:
    creates: "/tmp/calico-applied.txt"
  register: apply_calico
  changed_when: apply_calico.rc == 0
  become_user: "{{ k8s_user }}" # Run as the k8s manager user

- name: create marker file for calico installation result
  file:
    path: "/tmp/calico-applied.txt"
    state: touch
  when: apply_calico.changed

# -----------------------------------------------------------------------------
# Worker Join Token
# -----------------------------------------------------------------------------

# Generate a fresh join token for worker nodes
- name: create a join token
  command: "kubeadm token create --print-join-command"
  register: join_command_raw
  changed_when: false

# Save the join command to a variable on the Ansible controller (localhost)
# This allows the 'k8s_worker_setup' role to access it later
- name: save the token and pass it to another plays
  set_fact:
    join_command: "{{ join_command_raw.stdout }}"
  delegate_to: localhost
  delegate_facts: true

# -----------------------------------------------------------------------------
# Jenkins User Configuration
# -----------------------------------------------------------------------------

# Configure Jenkins user with kubectl access (for pipeline deployments)
- name: create kube config directory for jenkins
  ansible.builtin.file:
    path: /home/jenkins/.kube
    state: directory
    owner: jenkins
    group: jenkins
    mode: '0755'

- name: copy admin.conf to jenkins user
  copy:
    remote_src: yes
    src: "/etc/kubernetes/admin.conf"
    dest: "/home/jenkins/.kube/config"
    owner: jenkins
    group: jenkins
    mode: '0644'    

      
