---
# -----------------------------------------------------------------------------
# Role: Kubernetes Worker Setup
# -----------------------------------------------------------------------------
# Joins the worker nodes to the Kubernetes cluster.
# - Resets the node (if previously joined) to ensure a clean state
# - Joins the cluster using the token generated by the Master role
# -----------------------------------------------------------------------------

# Reset the node if it was previously part of a cluster
# This helps prevent issues when re-running the playbook
- name: 1. Reset worker node (if previously joined)
  command: |
     kubeadm reset -f \
     --cri-socket=unix:///var/run/cri-dockerd.sock
  ignore_errors: yes 

# Remove the node from the master's record (executed on master)
- name: Delete node from cluster
  command: kubectl delete node {{ ansible_fqdn }}
  delegate_to: master-node
  become_user: k8s_manger
  ignore_errors: yes 

# Restart kubelet to ensure it's fresh
- name: restart kublet
  service:
    name: kubelet
    state: restarted  

# Join the cluster
# Uses the 'join_command' variable passed from the 'k8s_master_setup' role
- name: 2. Join worker to the cluster
  command: "{{ hostvars['localhost']['join_command'] }} --cri-socket=unix:///var/run/cri-dockerd.sock"
  register: join_status
  changed_when: "'This node has joined the cluster' in join_status.stdout"

