---
# -----------------------------------------------------------------------------
# Role: Docker Installation
# -----------------------------------------------------------------------------
# Installs and configures Docker CE on both Debian/Ubuntu and RedHat systems.
# - Adds official Docker repositories
# - Installs Docker Engine, CLI, and Compose plugin
# - Configures the ansible user to run Docker commands without sudo
# -----------------------------------------------------------------------------

# Check if Docker is already installed to avoid unnecessary steps
- name: check docker is installed
  command : which docker
  register: docker_check
  ignore_errors: true

# -----------------------------------------------------------------------------
# Debian/Ubuntu Specific Tasks
# -----------------------------------------------------------------------------

# Install prerequisites for adding apt repositories
- name: install docker dependincies
  apt:
    name:
      - curl
      - ca-certificates
      - gnupg
    state: present
    update_cache: yes
  when:
    - docker_check.failed
    - ansible_os_family == "Debian"

# Create directory for storing GPG keys securely
- name: Create directory for Docker GPG keyrings (Debian/Ubuntu)
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  when:
    - docker_check.rc != 0
    - ansible_os_family == "Debian"

# Download Docker's official GPG key
- name: Download the Docker GPG key
  ansible.builtin.get_url:
      url: https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg
      dest: /etc/apt/keyrings/docker.asc
      mode: 'a+r'
  when:
    - docker_check.rc != 0
    - ansible_os_family == "Debian"

# Add Docker repository to apt sources
- name: Add the repository to Apt sources
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
    filename: docker
    state: present
    update_cache: yes
  when :
    - docker_check.rc != 0
    - ansible_os_family == "Debian"

# -----------------------------------------------------------------------------
# RedHat/CentOS Specific Tasks
# -----------------------------------------------------------------------------

# Add Docker repository for RedHat-based systems
- name: add Docker repository
  ansible.builtin.yum_repository:
    name: docker-ce-stable
    state: present
    baseurl: https://download.docker.com/linux/rhel/9/$basearch/stable/
    gpgkey: https://download.docker.com/linux/rhel/gpg
    enabled: yes
    gpgcheck: yes
    description: Docker CE repo stable
  when:
    - ansible_os_family == "RedHat"
    - docker_check.rc != 0

# Refresh package metadata cache
- name: Clean and rebuild DNF/YUM metadata cache
  ansible.builtin.dnf:
    name: '*' 
    state: latest 
    update_cache: yes
  when: ansible_os_family == "RedHat"
  become: yes

# -----------------------------------------------------------------------------
# Common Installation Tasks
# -----------------------------------------------------------------------------

# Install Docker Engine and related plugins
- name: install docker engine
  ansible.builtin.package:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
  notify: start_enable_docker

# Add the current ansible user to the 'docker' group
# This allows running docker commands without 'sudo'
- name: add ansible user for Docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes

