# -----------------------------------------------------------
# Deployment: frontend
# Purpose: Runs the React frontend application inside the cluster
# Integrates with AWS S3, backend API, and uses private registry images
# -----------------------------------------------------------

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: amazona
spec:
  # Number of frontend pod replicas (configurable via values.yaml)
  replicas: {{ .Values.frontend.replicas }}

  # Identifies pods belonging to this Deployment
  selector:
    matchLabels:
      app: frontend

  template:
    metadata:
      labels:
        app: frontend
      annotations:
        # Prometheus Scrape Annotations:
        # Tells Prometheus to discover and scrape metrics from this pod
        prometheus.io/scrape: "true"
        prometheus.io/port: "9113"      # Port where metrics are exposed
        prometheus.io/path: "/metrics"  # HTTP path for metrics

    spec:
      # Pull container images from private registry using secret
      imagePullSecrets:
      - name: regcred

      containers:
      - name: frontend
        image: {{ .Values.frontend.image }}

        # Expose the container's internal HTTP port
        ports:
        - containerPort: {{ .Values.frontend.port }}

        env:
        # API endpoint used by the frontend to communicate with backend services
        - name: REACT_APP_API_URL
          valueFrom:
            configMapKeyRef:
              name: amazona-config
              key: react-app-api-url

      # -------------------------------------------------------
      # Sidecar Container: nginx-exporter
      # Purpose:
      #   - Connects to the local Nginx instance (stub_status)
      #   - Extracts metrics and exposes them for Prometheus
      # -------------------------------------------------------
      - name: nginx-exporter
        image: nginx/nginx-prometheus-exporter:0.11
        args:
          # Scrape the local Nginx stub_status page
          - -nginx.scrape-uri=http://127.0.0.1:80/stub_status
        ports:
        - containerPort: 9113
          name: metrics

