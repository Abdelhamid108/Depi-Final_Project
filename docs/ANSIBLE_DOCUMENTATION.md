# Ansible System Documentation

**Project:** Depi Final Project Infrastructure  
**Version:** 1.4  
**Last Updated:** 2025-11-29

## 1. System Overview

This documentation describes the Ansible automation suite designed to provision and configure the project's infrastructure on AWS. The system automates the deployment of a Jenkins CI/CD environment and a Kubernetes cluster.

### 1.1. Architecture
The automation targets EC2 instances provisioned by Terraform and configures them into the following roles:

*   **Jenkins Master**: The CI/CD controller.
*   **Jenkins Agents**: Worker nodes for executing pipelines.
*   **Kubernetes Master**: The control plane for the container orchestration cluster.
*   **Kubernetes Workers**: Compute nodes for running application workloads.

## 2. Directory Hierarchy

The following tree represents the exact structure of the `ansible/` directory.

```text
ansible/
├── ansible.cfg                 # Global Ansible configuration
├── site.yml                    # Main playbook (Entry Point)
├── inventory/
│   ├── hosts.ini               # Dynamic inventory (Generated by Terraform)
│   └── group_vars/             # Variables applied to host groups
│       ├── all.yml             # Global variables (e.g., ansible_user)
│       ├── jenkins_masters.yml # Encrypted secrets (Vault)
│       ├── k8s_masters.yml     # Master-specific vars
│       └── k8s_workers.yml     # Worker-specific vars (ProxyJump)
├── playbooks/                  # Modular playbooks included by site.yml
│   ├── initialization.yml
│   ├── docker_installation.yml
│   ├── jenkins_agents_setup.yml
│   ├── jenkins_master_setup.yml
│   └── k8s_cluster_setup.yml
└── roles/                      # Reusable configuration units
    ├── initialization/
    │   └── tasks/main.yml
    ├── Docker_installation/
    │   ├── handlers/main.yml
    │   └── tasks/main.yml
    ├── jenkins_agents_setup/
    │   ├── files/depi_jenkins_rsa.pub  # Public key for agent access
    │   ├── handlers/main.yml
    │   └── tasks/main.yml
    ├── jenkins_master_setup/
    │   ├── handlers/main.yml
    │   ├── tasks/main.yml
    │   └── vars/main.yml       # Plugin list
    ├── k8s_common_setup/
    │   ├── tasks/main.yml
    │   └── vars/main.yml       # K8s & cri-dockerd versions
    ├── k8s_master_setup/
    │   ├── tasks/main.yml
    │   └── vars/main.yml       # Network CIDR & User config
    ├── k8s_worker_setup/
    │   └── tasks/main.yml
    └── aws_controllers/
        └── tasks/main.yml
```

## 3. Configuration Reference

This section details every configuration file and variable source within the system.

### 3.1. Global Configuration
*   **File**: `ansible/ansible.cfg`
*   **Settings**:
    *   `inventory`: `./inventory/hosts.ini`
    *   `remote_user`: `admin` (Overridden by group_vars)
    *   `host_key_checking`: `False` (Disabled for automation)
    *   `roles_path`: `./roles`
    *   `become`: `true` (Root privilege escalation enabled globally)

### 3.2. Inventory
*   **File**: `ansible/inventory/hosts.ini`
*   **Type**: Dynamic
*   **Description**: Generated automatically by Terraform. Contains public IP addresses of all instances grouped by function (`jenkins_masters`, `jenkins_agents`, `k8s_masters`, `k8s_workers`).

### 3.3. Variable Definitions
Variables are defined in multiple locations with specific precedence.

#### A. Group Variables (`inventory/group_vars/`)
These apply to specific groups of hosts defined in the inventory.

1.  **`all.yml`**
    *   **Scope**: All hosts.
    *   **Variables**:
        *   `ansible_user`: `ec2-user` (The actual connection user).

2.  **`jenkins_masters.yml`**
    *   **Scope**: `jenkins_masters` group.
    *   **Status**: **Encrypted (Ansible Vault)**.
    *   **Variables**:
        *   `aws_access_key_id`: AWS Access Key.
        *   `aws_secret_access_key`: AWS Secret Key.
        *   `mongo_db_user`: MongoDB Username.
        *   `mongo_db_pass`: MongoDB Password.
        *   `amazona_jwt_secret`: Application JWT Secret.

3.  **`k8s_workers.yml`**
    *   **Scope**: `k8s_workers` group.
    *   **Variables**:
        *   `ansible_ssh_common_args`: Configures `ProxyJump` to access private workers via the master node.

#### B. Role Variables (`roles/<role>/vars/main.yml`)
These are specific to the configuration of individual roles.

1.  **`jenkins_master_setup/vars/main.yml`**
    *   `jenkins_plugins`: A list of plugins to install (e.g., `git`, `workflow-aggregator`, `docker-plugin`, `aws-credentials`).

2.  **`k8s_common_setup/vars/main.yml`**
    *   `cri_dockerd_version`: `0.3.21`
    *   `KUBERNETES_VERSION`: `v1.34`

3.  **`k8s_master_setup/vars/main.yml`**
    *   `pod_network_cidr`: `192.168.0.0/16`
    *   `k8s_user`: `k8s_manger` (**Note**: Specific username used for K8s operations).
    *   `kubernetes_version`: `v1.34.0`
    *   `cluster_name`: `kubernetes`

## 4. Role Specifications

This section describes the function and key actions of each role.

### 4.1. `initialization`
*   **Purpose**: Bootstraps the node with essential utilities.
*   **Key Actions**:
    *   Updates package cache.
    *   Installs `vim`, `git`, `curl`, `acl`, `python3-pip`.
    *   Installs `kubernetes` Python library and `helm`.

### 4.2. `Docker_installation`
*   **Purpose**: Installs the container runtime.
*   **Key Actions**:
    *   Adds Docker repository.
    *   Installs `docker-ce`, `docker-ce-cli`, `containerd.io`.
    *   Adds `ec2-user` to the `docker` group.
*   **Handlers**: Starts and enables the Docker service.

### 4.3. `jenkins_agents_setup`
*   **Purpose**: Prepares nodes to accept Jenkins jobs.
*   **Key Actions**:
    *   Installs `openssh-server` and `fontconfig`.
    *   Installs Java 21 (`temurin-21-jdk`).
    *   Creates `jenkins` user.
    *   **Authorization**: Copies `files/depi_jenkins_rsa.pub` to `~jenkins/.ssh/authorized_keys`.

### 4.4. `jenkins_master_setup`
*   **Purpose**: Deploys the Jenkins Controller.
*   **Key Actions**:
    *   Installs Jenkins package.
    *   **Automation**: Unlocks Jenkins using Groovy scripts (bypassing the setup wizard).
    *   **Plugins**: Installs plugins defined in `vars/main.yml`.
    *   **Credentials**: Creates system credentials using secrets from `group_vars/jenkins_masters.yml`.

### 4.5. `k8s_common_setup`
*   **Purpose**: Base Kubernetes configuration for all nodes.
*   **Key Actions**:
    *   Disables Swap.
    *   Loads Kernel Modules: `overlay`, `br_netfilter`.
    *   Installs `cri-dockerd` (Docker Shim).
    *   Installs `kubelet`, `kubeadm`, `kubectl`.
    *   **Cloud Provider**: Configures `kubelet` with `--cloud-provider=external` and `--provider-id`.

### 4.6. `k8s_master_setup`
*   **Purpose**: Bootstraps the Control Plane.
*   **Key Actions**:
    *   Pulls container images.
    *   Runs `kubeadm init`.
    *   Configures `k8s_manger` user.
    *   Installs **Calico CNI** network plugin.
    *   Generates and exports the **Join Token**.

### 4.7. `k8s_worker_setup`
*   **Purpose**: Joins worker nodes to the cluster.
*   **Key Actions**:
    *   Resets node state.
    *   Executes `kubeadm join` using the token from the master.

### 4.8. `aws_controllers`
*   **Purpose**: Installs AWS-specific cluster components.
*   **Key Actions**:
    *   Installs **AWS Cloud Controller Manager** (Helm).
    *   Installs **AWS Load Balancer Controller** (Helm).
    *   Installs **NGINX Ingress Controller** (LoadBalancer Service).
    *   Installs **Cert Manager**.

## 5. Deployment Procedure (SOP)

To deploy this infrastructure on a new machine (the "Control Node"), follow these procedures.

### 5.1. Prerequisites
1.  **Ansible Installed**: Ensure Ansible is installed on the Control Node.
2.  **SSH Keys**:
    *   **AWS Key**: You must possess the private key (`.pem` or `id_rsa`) used to create the EC2 instances.
    *   **Jenkins Key**: You must generate a key pair for Jenkins:
        ```bash
        ssh-keygen -t rsa -b 4096 -f ~/.ssh/jenkins_key
        ```
        *Ensure the public key is placed in `ansible/roles/jenkins_agents_setup/files/depi_jenkins_rsa.pub`.*

### 5.2. Environment Setup

#### Step 1: Clone Repository
Clone the project repository to the Control Node to get the Ansible code.

#### Step 2: Verify Inventory
Ensure `ansible/inventory/hosts.ini` exists. This file is dynamically generated by Terraform and is required for Ansible to target the correct infrastructure.

#### Step 3: Configure SSH Agent (Critical)
Load the AWS private key into the SSH Agent to enable secure access to private subnets.

**Command:**
```bash
eval $(ssh-agent -s)
ssh-add /path/to/your/aws_key.pem
```

**Technical Justification:**
The infrastructure utilizes a **Bastion Host architecture** where Kubernetes Worker nodes reside in **Private Subnets** for enhanced security, making them inaccessible directly from the internet.
*   **ProxyJump**: The Ansible configuration (`group_vars/k8s_workers.yml`) implements the `-o ProxyJump` directive to route traffic through the Master node (Bastion).
*   **Agent Forwarding**: `ssh-agent` forwarding is required to authenticate with the Worker nodes using the local private key without exposing the key material to the intermediate Bastion host.

### 5.3. Execution
1.  Navigate to the Ansible directory:
    ```bash
    cd ansible
    ```
2.  Run the main playbook. You will be prompted for the Vault Password.
    ```bash
    ansible-playbook -i inventory/hosts.ini site.yml --ask-vault-pass
    ```
    *   **Note**: `site.yml` orchestrates the execution of all roles in the required dependency order.

### 5.4. Verification
1.  **Jenkins**: Access `http://<JENKINS_MASTER_IP>:8080`. Login with `admin` / `admin` (or the configured credentials).
2.  **Kubernetes**: SSH into the K8s Master and run:
    ```bash
    sudo -i -u k8s_manger
    kubectl get nodes
    kubectl get pods -A
    ```
    *All nodes should be `Ready` and all system pods `Running`.*

## 6. Troubleshooting

This section provides technical resolution steps for common failure scenarios.

### 6.1. SSH Connection Failures
**Symptom**: `Permission denied (publickey)` or `UNREACHABLE` errors when connecting to Worker nodes.
**Root Cause**: SSH Agent is not running, or the AWS private key is not added to the agent.
**Resolution**:
1.  Verify agent status: `echo $SSH_AUTH_SOCK`. If empty, start the agent: `eval $(ssh-agent -s)`.
2.  Verify key addition: `ssh-add -l`. If empty, add the key: `ssh-add /path/to/key.pem`.

### 6.2. Inventory Parsing Errors
**Symptom**: `Unable to parse /inventory/hosts.ini` or `No hosts matched`.
**Root Cause**: The Terraform state has not been applied, or the output file generation failed.
**Resolution**:
1.  Navigate to the Terraform directory.
2.  Run `terraform apply` to regenerate the `hosts.ini` file.
3.  Verify the file content: `cat ansible/inventory/hosts.ini`.

### 6.3. Kubernetes Permission Denied
**Symptom**: `error: You must be logged in to the server` or `Permission denied` when running `kubectl`.
**Root Cause**: Attempting to run `kubectl` as `ec2-user` or `root` without proper configuration.
**Resolution**:
1.  Switch to the dedicated Kubernetes manager user: `sudo -i -u k8s_manger`.
2.  **Note**: Ensure you use the spelling `k8s_manger` (as defined in the codebase), not `k8s_manager`.

### 6.4. Ansible Vault Decryption Failed
**Symptom**: `Decryption failed` during playbook execution.
**Root Cause**: Incorrect vault password provided or `--ask-vault-pass` flag omitted.
**Resolution**:
1.  Ensure the command includes `--ask-vault-pass` or `--vault-password-file`.
2.  Verify the vault password against the `inventory/group_vars/jenkins_masters.yml` file.

